# 测试用例设计与实现规范

本文档规定**测试用例本身**的设计格式与测试代码的实现规则，不规定 OpenSpec 流程或产物结构；与 design/tasks 等产物的衔接由 `openspec/config.yaml` 约定。

## 1. 适用范围

- 本规范适用于本项目中的单元测试/集成测试：如何设计单条用例、如何组织测试文件与编写断言。
- 与项目现有设计级用例表 `src/__tests__/用例表.md` 的关系：测试设计或实现中可引用 UC-xxx 用例 ID 及对应测试路径，便于与用例表同步。

## 2. 设计怎么写（单条用例设计）

一条可执行的测试用例设计应包含以下四项，便于直接转化为 it 内的 arrange/act/assert 与 expect：

| 设计要写的项 | 说明 |
|--------------|------|
| **测什么** | 行为点或 Scenario 名称（对应需求的 WHEN/THEN 要点） |
| **条件** | 前置与输入：如何构造（如传参、文件内容、diff、配置） |
| **期望** | 可观测结果（如 result 非 null、某字段取值、执行顺序） |
| **断言要点** | 实现时必验的点，可直接转化为 it 内的 expect（如 `expect(result).not.toBeNull()`、某 snippet 行数 ≤ maxNodeLines） |

**表格模板**（可复用于任一测试设计文档）：

| 测什么 | 条件 | 期望 | 断言要点 |
|--------|------|------|----------|
| （Scenario 或行为点） | （输入/前置） | （THEN 的具象化） | （expect 要点） |

**示例**（astScope 大节点截断）：

| 测什么 | 条件 | 期望 | 断言要点 |
|--------|------|------|----------|
| 单节点超 maxNodeLines 时截断并继续 | 某节点行数 > options.maxNodeLines；content + fileDiff 构造出该节点 | result 非 null；该节点只取前 maxNodeLines 行；其余节点正常输出 | `expect(result).not.toBeNull()`；该 snippet 的 `endLine - startLine + 1 <= maxNodeLines`；snippets 数量/内容符合预期 |

## 3. 实现怎么写（测试文件与单条用例）

### 3.1 技术栈与目录

- **框架**：Vitest；**语言**：TypeScript；**编码**：UTF-8。
- **位置**：测试与源码镜像，`src/__tests__/` 下目录与 `src/` 对应（如 `src/core/foo.ts` → `src/__tests__/core/foo.test.ts`）。
- **命名**：单文件测试为 `<模块名>.test.ts`；专项测试可为 `<模块名>.<场景>.test.ts`。

### 3.2 测试文件结构

- **文件头**：文件顶部用注释简要说明本文件测哪个模块、对应哪份需求或设计文档（如 change 名、spec 路径），便于追溯。
- **describe 分层**：
  - **顶层**：被测对象（如 `getAffectedScope` 或模块名）；
  - **下一层**：按场景/Scenario 或按条件类型分（如「Vue SFC」「大节点截断」「相邻合并」）；
  - **再下一层**（可选）：按具体条件细分（如「无 hunk」「单节点超限」「K<0 关闭合并」）。

### 3.3 单条 it 的写法与断言

- **单条 it**：
  - **标题**：能对应「测什么」或 Scenario 名，便于与设计对照。
  - **体内**：按 **arrange（条件构造）→ act（调用/触发）→ assert（按断言要点写 expect）** 组织；条件尽量用项目内已有手段（如 `makeFileDiff`、`testFixtures`、options 传参）。
- **断言**：
  - 先写设计里「断言要点」对应的 expect，保证设计与实现一一对应。
  - 推荐风格：先判非 null/形态（如 result 存在、类型正确），再判关键字段（如行号、长度、内容）；避免无谓的重复断言。

### 3.4 Mock 与依赖

- VSCode API 在 `src/__tests__/setup.ts` 中统一 mock。
- 优先使用 `src/__tests__/helpers/` 下的 fixture（如 mockConfigManager、tempFileSystem、testFixtures）。

### 3.5 与用例表（UC-xxx）的衔接

- 若被测逻辑属于 `src/__tests__/用例表.md` 中某条 UC-xxx，在测试设计或实现中注明对应**用例 ID** 及**对应测试**列中的现有测试路径。
- 新增测试若可归属某 UC-xxx，在测试设计或任务描述中写上该用例 ID，便于后续同步回用例表。

## 4. 设计 ↔ 实现对应关系

- **对应关系**：每条用例设计（或表格中的一行）对应实现里的**一个或一组** `it`。实现时按设计中的「条件」列构造输入（arrange），按「断言要点」列写 expect（assert），保证可追溯。
- **验收**：可通过 it 与断言要点的对应关系做自检；需新增的用例应有对应 it 且断言覆盖设计中的断言要点。

## 5. 检查清单（测试质量）

- [ ] 每条需覆盖的行为点均有用例设计（含测什么、条件、期望、断言要点）。
- [ ] 新增或修改的测试文件符合目录与命名规范，UTF-8 编码；单条 it 按 arrange/act/assert 组织，断言与设计「断言要点」对应（见 3.3、§4）。
- [ ] 若涉及用例表已有 UC-xxx，已在测试设计或实现中引用；需要时可同步更新用例表。
