# 用例设计与实现规范优化 - 技术设计

## Context

- **当前状态**：`openspec/测试用例设计与实现规范.md` 已规定测试设计融入 design/tasks、design 必备「测试与验证」、覆盖策略（已有/需新增），以及实现侧技术栈、目录、describe/it、mock。缺少「设计阶段每条用例写什么」（测什么、条件、期望、断言要点）和「实现阶段测试文件与单条用例怎么写」（文件结构、分层、条件构造、断言方式及与设计的对应）。
- **约束**：不新增 OpenSpec artifact 类型；规范仍针对同一文档；UTF-8 编码。
- **干系人**：所有通过 OpenSpec 做 change 并写单测的开发者。

## Goals / Non-Goals

**Goals:**

- 规范文档明确「设计怎么写」：design 的「测试与验证」中每条用例设计必须包含测什么、条件、期望、断言要点，并配有表格或示例。
- 规范文档明确「实现怎么写」：测试文件结构（文件头、describe 分层）、单条 it 的 arrange/act/assert、断言与「断言要点」的对应及推荐风格。
- 规范文档明确「设计 ↔ 实现」对应关系：一条用例设计对应一个或一组 it，实现时按条件构造、按断言要点写 expect，便于追溯与验收。

**Non-Goals:**

- 不改变 OpenSpec 的 artifact 类型或流程；不强制现有 change  retrofitting 新格式（仅对新写或修订的「测试与验证」生效）。

## Decisions

### D1：在规范中增加「设计怎么写」小节

- **选择**：在 `测试用例设计与实现规范.md` 的「测试设计融入 design.md」下增加子小节「设计怎么写」，规定每条用例设计必须包含四项：测什么、条件、期望、断言要点；并提供表格模板与示例（如 astScope 截断）。
- **理由**：与讨论结论一致——设计要落到可执行粒度，实现者可直接按表写 it。

### D2：在规范中增加「实现怎么写」小节

- **选择**：在「测试实现规范」中扩展为：文件头（测哪个模块、对应哪份 spec/design）、describe 分层规则（顶层=被测对象、下一层=场景/Scenario 或条件类型）、单条 it 的 arrange/act/assert、断言优先写 design 中的「断言要点」、推荐风格（先形态后关键字段）。
- **理由**：统一测试文件形状，便于阅读与评审，并与 design 一一对应。

### D3：设计 ↔ 实现对应关系单独成小节

- **选择**：在规范中增加「设计 ↔ 实现对应关系」小节，说明 design 中「测试与验证」的一行（或每条用例设计）对应实现里一个或一组 it；实现时条件按「条件」列构造、断言按「断言要点」列写；实现后可勾选或更新 design 的「已有覆盖」。
- **理由**：明确追溯与验收方式，避免设计与实现脱节。

### D4：不新增 artifact，仅改规范文档

- **选择**：所有内容写入现有 `openspec/测试用例设计与实现规范.md`，不新增 test-design 等 artifact。
- **理由**：与既有决策一致，符合 OpenSpec 现有产物规范。

## Risks / Trade-offs

| 风险 | 缓解 |
|------|------|
| 规范变长，阅读成本增加 | 用表格与示例代替长段落；保留目录与检查清单便于跳转 |
| 已有 change 的「测试与验证」格式不统一 | 不强制回溯；新写或修订时按新规范即可 |

## Migration Plan

- **部署**：合并后更新 `openspec/测试用例设计与实现规范.md` 即可；无数据迁移。
- **回滚**：用版本控制还原文档。

## 测试与验证

本变更为文档型变更，不涉及可执行代码行为；验收以文档评审与规范内检查清单为准。

| Scenario（要点） | 覆盖策略 | 对应测试 |
|------------------|----------|----------|
| 规范文档包含「设计怎么写」并含表格/示例 | 需新增 | 文档评审：openspec/测试用例设计与实现规范.md 存在该小节且内容符合 proposal |
| 规范文档包含「实现怎么写」并含文件结构/arrange-act-assert/断言 | 需新增 | 同上 |
| 规范文档包含「设计↔实现对应关系」说明 | 需新增 | 同上 |

- **已有测试文件**：无（规范文档无单测）。
- **需新增/修改**：无自动化测试；tasks 中验收任务为「更新规范文档并自检检查清单」。

## Open Questions

- 无。
