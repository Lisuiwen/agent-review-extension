# AgentReview 设计级用例表（当前实现）

<style>
/* 表列最小宽度，避免「优先级」「功能域」在预览中竖排显示 */

table th:nth-child(3),
table td:nth-child(3) { min-width: 5em; }
</style>

## 1. 文档范围与术语

### 1.1 范围
- 本文档仅覆盖当前代码分支中**已实现能力**，不包含规划中未落地特性。
- 本文档作为 `AgentReview` 用例设计与评审基线，主文件路径固定为 `src/__tests__/用例表.md`。
- 用例目标是“可执行、可追踪、可验收”：每条用例均映射代码入口与现有测试标题。

### 1.2 术语
- `pending diff`：待提交增量（`HEAD..WorkingTree`），包含 staged + unstaged + untracked。
- `staged diff`：暂存区增量（`git diff --cached`）。
- `working diff`：工作区未暂存增量（`git diff` + untracked 补全）。
- `stale`：问题行号已本地同步但语义可能过期，待复审。
- `scope hints`：基于 stale 问题范围（AST/line）的切片复审提示。
- `noise_only_change`：仅格式/空白或仅注释变更，自动复审应跳过。

## 2. 用例分级与优先级规则

### 2.1 用例字段规范
- 每条用例必须包含：`用例ID`、`优先级`、`功能域`、`触发入口`、`前置条件`、`主流程`、`异常流`、`期望结果`、`关键配置`、`可观测信号（UI/日志）`、`对应测试`。

### 2.2 用例ID规则
- `UC-MAN-*`：手动审查命令
- `UC-AUTO-*`：自动复审链路
- `UC-ENG-*`：审查引擎
- `UC-AI-*`：AI 调用与降载
- `UC-UI-*`：结果面板与交互
- `UC-IGNORE-*`：放行与忽略
- `UC-LOG-*`：运行日志
- `UC-CONF-*`：配置与环境变量

### 2.3 优先级规则
- `P0`：阻断提交、误报治理、数据一致性。
- `P1`：常规用户链路与主交互体验。
- `P2`：辅助能力、诊断能力、运维体验。

## 3. 核心用例清单（产品视角）

### 3.1 手动审查命令（UC-MAN）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-MAN-001 | P1 | 手动审查命令 | `agentreview.run` | 插件已激活，存在 pending 变更 | 执行命令 -> `reviewPendingChangesWithContext` -> 展示结果 | 审查过程异常 | 面板显示本次结果，状态栏同步统计 | `rules.diff_only`、`ai_review.diff_only` | TreeView 进入 reviewing 后 completed；输出日志出现 run_start/run_end | `src/__tests__/commands/runReviewCommand.test.ts::reviewed+non-empty 时应正常覆盖显示` |
| UC-MAN-002 | P1 | 手动审查命令 | `agentreview.run` | 无 pending 变更 | 执行命令 -> `reason=no_pending_changes` | 无 | 显示“没有待提交变更需要审查” | 无 | 面板 emptyStateHint；状态栏回到 ready | `src/__tests__/commands/runReviewCommand.test.ts::no_pending_changes 时应显示“没有待提交变更需要审查”` |
| UC-MAN-003 | P0 | 手动审查命令 | `agentreview.run` | 当前已有历史问题，本次 reviewed 结果为空 | 执行命令 -> 命中保留历史分支 | 无 | 不覆盖历史问题，仅更新子状态“复审未命中，保留历史问题” | 无 | 状态栏 tooltip 含保留历史文案 | `src/__tests__/commands/runReviewCommand.test.ts::reviewed+empty+有历史问题时应保留历史，不覆盖列表` |
| UC-MAN-004 | P1 | 手动审查命令 | `agentreview.run` 重复点击 | 首次命令执行中 | 第二次点击命中 inProgress 防重入 | 无 | 第二次触发被忽略，提示“审查进行中” | 无 | 信息提示弹窗；引擎仅被调用一次 | `src/__tests__/commands/runReviewCommand.test.ts::并发双击刷新时应忽略第二次触发且不重复调用引擎` |
| UC-MAN-005 | P1 | 手动审查命令 | `agentreview.runStaged` | 有/无 staged 文件 | 执行命令 -> `reviewStagedFiles` | 组件未初始化或审查异常 | 有 staged 时展示结果；无 staged 时展示“没有staged文件需要审查” | `rules.diff_only`、`ai_review.diff_only` | 侧边栏 progress + 状态栏更新 | `src/__tests__/commands/runStagedReviewCommand.test.ts::成功路径应调用 staged 审查并更新 UI`；`src/__tests__/commands/runStagedReviewCommand.test.ts::组件未初始化时应提示错误并返回`；`src/__tests__/commands/runStagedReviewCommand.test.ts::异常路径应设置错误状态并提示` |
| UC-MAN-006 | P2 | 手动审查命令 | `agentreview.review`/`agentreview.refresh`/`agentreview.showReport` | 插件已激活 | review/refresh 转发 run；showReport 打开结果面板 | 面板未初始化 | 命令别名与刷新链路可用，面板可显式拉起 | 无 | 命令执行日志；面板 reveal | `src/__tests__/commands/showReportCommand.test.ts::存在 panel 时应调用 reveal`；`src/__tests__/commands/showReportCommand.test.ts::不存在 panel 时应提示信息` |

### 3.2 自动复审（UC-AUTO）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-AUTO-001 | P1 | 自动复审 | 文件保存事件 | `ai_review.enabled=true` 且 `run_on_save=true` | 保存 -> 防抖 -> 同文件任务合并 -> 入队执行 | 无 | 同文件高频保存只保留最新任务 | `agentreview.ai.runOnSave`、`agentreview.ai.runOnSaveDebounceMs` | 子状态“复审排队中（已合并保存）” | `src/__tests__/phase3Optimization.test.ts::保存事件应走单文件 scope 复审入口` |
| UC-AUTO-002 | P1 | 自动复审门控 | 保存触发 | 存在上次内容哈希 | `savedContentHash == lastReviewedContentHash` | 无 | 跳过复审，理由 `same_content` | `agentreview.ai.runOnSaveSkipSameContent` | 子状态“内容未变化，已跳过自动复审” | `src/__tests__/core/autoReviewGate.test.ts::相同内容哈希应跳过 same_content` |
| UC-AUTO-003 | P1 | 自动复审门控 | 保存触发 | 无 pending diff | gate 判断 `no_pending_diff` | 无 | 跳过复审，避免空跑 | 无 | 子状态“未检测到待审查变更” | `src/__tests__/core/autoReviewGate.test.ts::无 pending diff 时应跳过 no_pending_diff` |
| UC-AUTO-004 | P1 | 自动复审门控 | 保存触发 | diff 标记为 formatOnly/commentOnly | gate 判断 `noise_only_change` | 无 | 跳过噪声变更复审 | `agentreview.ai.ignoreFormatOnlyDiff`、`agentreview.ai.ignoreCommentOnlyDiff` | 子状态提示跳过；可记录 auto_review_skipped | `src/__tests__/core/autoReviewGate.test.ts::formatOnly 变更应跳过 noise_only_change`；`src/__tests__/core/autoReviewGate.test.ts::commentOnly 变更应跳过 noise_only_change` |
| UC-AUTO-005 | P1 | 自动复审门控 | 保存触发 | 文件存在高优先级 diagnostics | gate 判断 `diagnostic_funnel` | 无 | 跳过自动复审，优先本地诊断修复 | `agentreview.ai.runOnSaveFunnelLintSeverity` | 子状态“检测到高优先级诊断，已跳过自动复审” | `src/__tests__/core/autoReviewGate.test.ts::命中 error 级 diagnostics 漏斗时应跳过 diagnostic_funnel` |
| UC-AUTO-006 | P1 | 自动复审门控 | 保存触发 | 改动行数小于阈值 | gate 判断小改动低风险；若命中风险特征则放行执行 | 无 | 小改动低风险跳过；风险命中不跳过 | `agentreview.ai.runOnSaveMinEffectiveChangedLines`、`agentreview.ai.runOnSaveRiskPatterns` | 跳过/执行文案分支正确 | `src/__tests__/core/autoReviewGate.test.ts::小改动且未命中风险特征时应跳过 small_low_risk_change`；`src/__tests__/core/autoReviewGate.test.ts::小改动但命中风险特征时不应跳过` |
| UC-AUTO-007 | P1 | 自动复审调度 | 保存触发高频 | 已达到每分钟上限 | 进入冷却队列 -> 到期重入执行 | 无 | 不丢任务，按限频窗口恢复 | `agentreview.ai.runOnSaveMaxRunsPerMinute` | 子状态“已限频，冷却中” | `src/__tests__/extension/autoReviewController.test.ts::save 前置门控：非 file 或 AI/save 开关关闭时不入队`（覆盖保存链路门控与调度前置） |
| UC-AUTO-008 | P0 | 自动复审一致性 | 保存/空闲/手动复审并发 | 文件继续编辑或再次保存 | 结果返回时比对 request/edit/save revision | 无 | 过期结果被丢弃，不污染面板 | 无 | 子状态“已丢弃过期结果” | `src/__tests__/extension/autoReviewController.test.ts::结果过期时应丢弃旧结果，不更新面板 patch` |
| UC-AUTO-009 | P1 | 自动复审 | 编辑停顿触发 | 文件存在 stale 且已保存且可见 | 计时到达 -> enqueue idle task -> 执行复审 | 文件不可见或 dirty | 仅在可复审条件下触发 idle recheck | `agentreview.ai.idleRecheckEnabled`、`agentreview.ai.idleRecheckMs` | 子状态“编辑暂停后待复审” | `src/__tests__/extension/autoReviewController.test.ts::idle 触发：仅在可见+非 dirty+stale 时触发` |
| UC-AUTO-010 | P1 | 自动复审 | `agentreview.reviewCurrentFileNow` | 当前活动编辑器为本地文件且已保存且 AI 启用 | 执行立即复审任务；可按配置绕过限频 | 文件未打开/未保存/AI关闭 | 正确提示前置条件；满足条件时立即入队 | `agentreview.ai.reviewCurrentFileNowBypassRateLimit` | 提示信息、状态文案“立即复审排队中” | `src/__tests__/extension/autoReviewController.test.ts::manual 触发前置：无编辑器/未保存/AI 未启用时应提示，满足条件后入队` |

### 3.3 审查引擎（UC-ENG）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-ENG-001 | P1 | 审查引擎 | 任一 review 入口 | 存在排除规则 | 输入文件先经 exclusions 过滤 | 无 | 被排除文件不进入规则/AI阶段 | `exclusions.files`、`exclusions.directories` | `file_filter_summary` 统计可见 | `src/__tests__/utils/fileScanner.test.ts::应该支持多个复杂模式` |
| UC-ENG-002 | P1 | 审查引擎 | review 入口 | 项目存在/不存在规则配置文件 | 有 diagnostics 且 `ruleSource=project` 则用 project_rule，否则 builtin | 无 | 规则源切换符合探测逻辑 | `rules.builtin_rules_enabled`（探测影响） | `config_snapshot.aiFunnelLint` 等链路日志 | `src/__tests__/config/configManager.test.ts::检测到项目规则文件且用户未显式配置时，builtin_rules_enabled 仍为 false、规则来源为 project` |
| UC-ENG-003 | P0 | 审查引擎 | review 入口 | 规则阶段出现 blocking 问题 | 命中 `skip_on_blocking_errors` 后跳过 AI | 无 | 减少无效 AI 调用，保持阻断一致 | `ai_review.skip_on_blocking_errors` | 日志“检测到阻断级规则问题，已跳过AI审查” | `src/__tests__/core/reviewEngine.optimization.test.ts::规则引擎发现 blocking 错误时应跳过 AI 审查` |
| UC-ENG-004 | P0 | 审查引擎 | review 入口 | strict 模式开/关 | strict 模式：任意 error 导致 failed；非 strict：仅 block_commit 规则阻断 | 无 | `result.passed` 判定符合策略 | `rules.strict_mode`、规则 action | 审查结果 passed/failed 与预期一致 | `src/__tests__/core/reviewEngine.test.ts::严格模式下所有错误都应该阻止提交`；`src/__tests__/core/reviewEngine.test.ts::非严格模式下只有 block_commit 的错误才阻止提交` |
| UC-ENG-005 | P1 | 审查引擎 | pending/staged/working 三入口 | 仓库状态变化 | 三入口分别获取 diff 并调用统一 `review` | 无 | 手动、staged、保存链路使用正确 diff 语义 | `rules.diff_only`、`ai_review.diff_only` | `diff_fetch_summary` 中 phase 与文件数正确 | `src/__tests__/core/reviewEngine.optimization.test.ts::手动 run 应使用 pending diff 作为默认审查范围`；`src/__tests__/core/reviewEngine.runtimeTrace.test.ts::staged 审查应输出关键链路事件（含 AI/LLM）` |
| UC-ENG-006 | P1 | 审查引擎 | `reviewSavedFileWithScopeHints` | 提供 scope hints | 构造切片 diff+AST override；若切片无效或空结果回退整文件 | 读文件失败/切片为空 | 复审优先切片，必要时安全回退 | `ast.enabled`、`ast.max_node_lines`、`ast.max_file_lines` | `diff_fetch_summary.reason` 可见回退原因 | `src/__tests__/core/reviewEngine.optimization.test.ts::保存复审 scope hints 时，应构造切片 diff 与 AST override`；`src/__tests__/core/reviewEngine.optimization.test.ts::切片复审返回空结果时，应回退整文件` |
| UC-ENG-007 | P0 | 审查引擎 | review 入口 | 已存在 ignore 指纹或 `@ai-ignore` 注释 | 先按指纹过滤（仅来自「忽略」），再按 @ai-ignore 注释行与下一非空行过滤（仅来自「放行」） | 文件读取失败 | 放行仅靠注释拦截，指纹只针对忽略；抗行号偏移 | `.vscode/agentreview-ignore.json`（version 2，items 含可读 meta） | 日志“已按指纹过滤/已过滤 @ai-ignore” | `src/__tests__/phase3Optimization.test.ts::插入 @ai-ignore 后应本地同步行号并打上已放行标记`；`src/__tests__/config/ignoreStore.test.ts` |
| UC-ENG-008 | P1 | 审查引擎 | review 入口 | 存在 diffByFile | 结果只包含变更行上的问题；无 diff 时结果含全部问题 | 无 | TreeView 分组数量按结果计数 | 无 | 结果仅含增量 | `src/__tests__/core/reviewEngine.optimization.test.ts::结果只包含变更行上的问题`；`src/__tests__/ui/reviewPanel.incremental.test.ts::分组数量应正确反映结果中的规则与 AI 问题` |

### 3.4 AI 审查流水线（UC-AI）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-AI-001 | P0 | AI 调用与降载 | AIReviewer.review | AI 开启 | 校验 endpoint/model/key；无效则短路 | URL 非法、占位符未解析 | 不发请求并给出可诊断日志 | `agentreview.ai.apiEndpoint`、`agentreview.ai.model`、`agentreview.ai.apiKey` | 日志提示“端点未配置/模型未配置” | `src/__tests__/core/aiReviewer.optimization.test.ts`（间接覆盖调用前校验） |
| UC-AI-002 | P1 | AI 调用与降载 | AIReviewer.review | 存在 diff/AST、可选 LSP 上下文 | 组装 diff/AST 内容 + 文件头依赖 + LSP references/usages | 片段缺失时回退整文件 | 输入上下文完整且仍受预算约束 | `ai_review.diff_only`、`ast.include_lsp_context` | 请求内容包含“当前审查代码/外部引用上下文” | `src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts::AST 模式应在发送内容中区分当前审查代码与外部引用上下文`；`src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts::AST 模式应补充文件头依赖上下文，降低外部变量未定义误报` |
| UC-AI-003 | P1 | AI 调用与降载 | AIReviewer.review | 批处理模式可配置 | `file_count` 按文件批次；`ast_snippet` 按片段预算切批 | 无 | 两种切批都不丢单元且可并发 | `agentreview.ai.batchingMode`、`agentreview.ai.astSnippetBudget`、`agentreview.ai.astChunkStrategy`、`agentreview.ai.batchConcurrency` | `ai_plan_summary` 的 units/batches/concurrency | `src/__tests__/core/aiReviewer.optimization.test.ts::batching_mode=file_count 时保持 5 文件一批`；`src/__tests__/core/aiReviewer.optimization.test.ts::AST 60 片段按预算 25 分批时应拆为 3 批，且同文件多单元不丢失` |
| UC-AI-004 | P1 | AI 调用与降载 | 批次执行 | 批次估算字符数超限 | 命中 `max_request_chars` 触发二分降载 | 二分后仍失败 | 批次自动拆分并继续执行 | `agentreview.ai.maxRequestChars` | 事件 `batch_split_triggered reason=max_request_chars` | `src/__tests__/core/aiReviewer.optimization.test.ts::请求超出 max_request_chars 时应自动二分降载` |
| UC-AI-005 | P1 | AI 调用与降载 | API 调用失败处理 | 返回 400/413 context too long | 识别上下文超限 -> 二分后重试一次 | 分裂后仍失败 | 尽量恢复审查，不直接中断整个链路 | 无 | 日志“context too long”与 split 事件 | `src/__tests__/core/aiReviewer.optimization.test.ts::400/context too long 时应触发批次二分降载重试` |
| UC-AI-006 | P1 | AI 调用与降载 | API 调用 | 出现 429/5xx/网络波动 | 指数退避重试，超限后失败上抛 | 不可重试错误 | 可重试错误按策略重试 | `agentreview.ai.retryCount`、`agentreview.ai.retryDelay` | `llm_retry_scheduled` 事件 | `src/ai/aiReviewer.api.ts::callReviewAPI`（由 `src/__tests__/core/aiReviewer.optimization.test.ts` 间接覆盖） |
| UC-AI-007 | P1 | AI 调用与降载 | OpenAI 响应解析 | 返回内容截断 | 识别 partial -> 续写请求 -> 合并去重 | 续写次数用尽 | 返回可解析部分并避免重复 issue | `agentreview.ai.maxTokens` | 日志“响应疑似被截断，尝试续写补全” | `src/__tests__/core/aiReviewer.optimization.test.ts::截断响应应触发续写并合并去重结果`；`src/__tests__/ai/aiReviewer.responseParser.test.ts::extractPartialJson 应从截断内容提取可用 issue` |
| UC-AI-008 | P0 | AI 调用与降载 | 提示词构建与结果过滤 | 存在 diagnostics | 构建已知问题白名单提示词 + 结果后置去重；过度过滤回退 | diagnostics 过滤后为 0 | 避免重复报同类问题且不空结果误伤 | `agentreview.ai.funnelLint`、`agentreview.ai.funnelLintSeverity` | 日志“已过滤与本地诊断高度重复的 AI 问题” | `src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts::构建请求时应带上已知问题白名单提示词`；`src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts::diagnostics 过滤后若变为 0，应回退保留原 AI 结果` |
| UC-AI-009 | P0 | AI 调用与降载 | AI 失败处理 | API 超时或异常 | 按 action 映射：warning/log 返回 issue，block_commit 抛异常阻断 | 无 | 失败行为与项目策略一致 | `agentreview.ai.action` | 结果中出现 `ai_review_error/ai_review_timeout` 或直接失败 | `src/__tests__/core/reviewEngine.test.ts::应该正确处理 AI 审查规则的 action`；`src/__tests__/ai/aiReviewer.transform.test.ts::actionToSeverity/mapSeverity 应正确映射边界` |

### 3.5 UI 交互（UC-UI）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-UI-001 | P1 | 结果面板与交互 | `showReviewResult` | 存在审查结果 | 根节点按规则/AI 分组展示（结果仅含增量） | 无结果时显示默认提示 | 分组统计准确 | 无 | `规则检测错误(N)`、`AI检测错误(N)` | `src/__tests__/ui/reviewPanel.incremental.test.ts::根节点应出现规则检测错误与AI检测错误两个分组`；`src/__tests__/ui/reviewPanel.incremental.test.ts::分组节点应按来源展示文件与问题` |
| UC-UI-002 | P1 | 结果面板与交互 | 空结果展示 | 审查通过且无问题 | 展示场景化 `emptyStateHint` | 无 | 提示语与触发场景一致 | 无 | 面板文案“当前保存文件复审未发现问题”等 | `src/__tests__/ui/reviewPanel.incremental.test.ts::无问题时应优先展示场景化 emptyStateHint` |
| UC-UI-003 | P1 | 结果面板与交互 | 选择问题节点 | 问题节点有效 | 打开文件并定位，高亮对应行；越界自动夹取安全行 | 文件不存在或路径无效 | 不崩溃，给出友好提示 | 无 | 编辑器高亮；警告提示 | `src/__tests__/phase3Optimization.test.ts::选中问题节点后应打开文件并定位到指定行列`；`src/__tests__/phase3Optimization.test.ts::行列越界时安全降级` |
| UC-UI-004 | P2 | 结果面板与交互 | 编辑器 Hover | 当前行命中问题 | 展示 severity、rule、reason、stale/ignored 状态及动作链接 | 无 | Hover 信息可读且可触发命令 | 无 | Hover 含 `[放行]`；非 error 时含 `· [忽略]` | `src/ui/reviewPanel.ts::buildIssueHoverMarkdown`（由 `src/__tests__/phase3Optimization.test.ts` 间接覆盖动作链路） |
| UC-UI-005 | P0 | 结果面板与交互 | `applyFileReviewPatch` | 已有历史结果与新结果 | 按 `stale_only/all_in_file` 规则替换；支持 diff 范围覆盖 | preserveStaleOnEmpty 分支 | 仅覆盖目标范围，避免重复叠加 | 无 | 子状态“复审完成（已保留历史/已最新保存）” | `src/__tests__/phase3Optimization.test.ts::stale_only 补丁应仅替换目标文件 stale 问题，并保留其他问题`；`src/__tests__/phase3Optimization.test.ts::stale_only + diff 应覆盖复审范围内旧 AI 问题，避免保存后重复叠加` |
| UC-UI-006 | P1 | 结果面板与交互 | 文档变更事件 | 启用本地重映射 | 行号重映射并标记 stale；大改动仅标 stale | 插入 `@ai-ignore` 文本变化 | stale 范围可被后续复审消费 | `agentreview.ai.enableLocalRebase`、`agentreview.ai.largeChangeLineThreshold` | 子状态“已同步位置（待复审）” | `src/__tests__/phase3Optimization.test.ts::应提取 stale scope hints，并优先合并 AST 范围` |

### 3.6 放行与忽略（UC-IGNORE）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-IGNORE-001 | P0 | 放行与忽略 | `agentreview.allowIssueIgnore` | 已选中问题节点 | 输入原因 -> 插入语言注释 -> 保存文件 -> 同步面板（仅注释，不写指纹） | 写入编辑失败 | 注释落地，后续审查按 @ai-ignore 行号过滤 | 无 | 提示“已插入 @ai-ignore 注释，此问题后续审查将被忽略” | `src/__tests__/commands/allowIssueIgnoreCommand.test.ts::typescript 文件应插入双斜杠注释并走成功链路`；`src/__tests__/commands/allowIssueIgnoreCommand.test.ts::applyEdit 返回 false 时应报错且不保存不同步` |
| UC-IGNORE-002 | P1 | 放行与忽略 | `agentreview.allowIssueIgnore` | 未选中问题节点 | 命令执行 | 无 | 给出引导提示，不进行写入 | 无 | 信息提示“请先在审查结果中选中一个问题...” | `src/__tests__/commands/allowIssueIgnoreCommand.test.ts::未选中问题时应提示并返回` |
| UC-IGNORE-003 | P1 | 放行与忽略 | `syncAfterIssueIgnore` | 已插入注释行 | 同文件 issue 行号平移并刷新 ignored/ignoreReason | 无 | 面板状态与文件真实行号一致 | 无 | 节点前缀显示“【已放行】” | `src/__tests__/phase3Optimization.test.ts::TreeView 问题节点应展示「已放行」前缀` |
| UC-IGNORE-004 | P0 | 放行与忽略 | `agentreview.ignoreIssue` | 已选中 warning/info 问题节点 | 计算指纹 -> 写入 .vscode/agentreview-ignore.json（version 2，含 file/line/rule/message/severity）-> 从列表移除该条 | 无 workspace/读文件失败 | 指纹落地，TreeView 立即删除该条，后续审查按指纹过滤 | 无 | 提示“已忽略，已从列表移除”；error 无此按钮 | `src/__tests__/commands/ignoreIssueCommand.test.ts`；`src/__tests__/config/ignoreStore.test.ts` |
| UC-IGNORE-005 | P1 | 放行与忽略 | `agentreview.ignoreIssue` | 未选中问题或选中的为 error | 命令执行 | 无 | 无 issue 时提示先选中；error 时提示不可忽略 | 无 | 信息提示“请先...后再执行忽略”或“error 级别不可忽略” | `src/__tests__/commands/ignoreIssueCommand.test.ts::无 issue 时应提示请先选中或悬停`；`::error 级别时应提示不可忽略且不调用 removeIssueFromList` |

### 3.7 运行日志与解释（UC-LOG）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-LOG-001 | P2 | 运行日志 | 任一 review 入口 | runtime_log 启用 | 每次运行生成独立 JSONL；按 level 过滤；按 retention 清理过期 | 写入失败 | 主流程不受影响，日志尽力落盘 | `agentreview.runtimeLog.enabled`、`agentreview.runtimeLog.level`、`agentreview.runtimeLog.retentionDays` | `runtime-logs/*.jsonl` 文件变化 | `src/__tests__/utils/runtimeTraceLogger.test.ts::每次运行会在 runtime-logs 下生成 JSONL 文件，且每行可解析`；`src/__tests__/utils/runtimeTraceLogger.test.ts::启动时按 retention_days 清理过期文件` |
| UC-LOG-002 | P2 | 运行日志 | `agentreview.runtimeLog.explainLatest` | 存在至少一份 jsonl | 找到最新 jsonl -> 生成 summary -> 打开文档 | 未找到日志文件 | 成功打开可读摘要或给出警告 | `agentreview.runtimeLog.humanReadable.granularity` | 信息提示“运行日志摘要已生成” | `src/__tests__/commands/explainRuntimeLogCommand.test.ts::应读取最新 jsonl 并生成 summary` |
| UC-LOG-003 | P2 | 运行日志 | 审查运行结束 | human_readable 自动生成开启 | run_end 后自动生成 `.summary.log` | 生成失败 | 失败仅告警，不中断审查 | `agentreview.runtimeLog.humanReadable.autoGenerateOnRunEnd` | 日志“自动生成运行时日志摘要失败”（失败分支） | `src/__tests__/utils/runtimeLogExplainer.test.ts::应生成 summary 文件` |

### 3.8 配置与环境变量（UC-CONF）

| 用例ID | 优先级 | 功能域 | 触发入口 | 前置条件 | 主流程 | 异常流 | 期望结果 | 关键配置 | 可观测信号（UI/日志） | 对应测试 |
|---|---|---|---|---|---|---|---|---|---|---|
| UC-CONF-001 | P0 | 配置与环境变量 | 插件激活/配置重载 | 同时存在 Settings/YAML/默认 | 按优先级合并配置 | YAML 格式错误 | Settings 覆盖 YAML，YAML 覆盖默认，失败回退安全 | 全部 `agentreview.*` 配置键 | 输出日志“从 VSCode Settings 加载...” | `src/__tests__/config/configManager.test.ts::仅配置 Settings 时，不应让默认覆盖 YAML 的 ai_review.run_on_save` |
| UC-CONF-002 | P1 | 配置与环境变量 | 配置解析 | 配置中存在 `${VAR}` | 先 `process.env`，后 `.env`，未命中保留占位 | 无 | 变量解析稳定且可诊断 | `agentreview.ai.apiEndpoint`、`agentreview.ai.apiKey`、`agentreview.ai.model` | warn 日志提示未定义变量 | `src/config/envResolver.ts::resolveEnvVariables`（由 `src/__tests__/config/configManager.test.ts` 间接覆盖） |
| UC-CONF-003 | P0 | 配置与环境变量 | 文件监听器触发 | `.agentreview.yaml` 或 `.env` 变更 | 防抖重载；若新配置可疑或加载失败回滚旧配置 | 无旧配置时失败 | 保持可用配置，避免意外退化 | `agentreview.configPath` | 通知“AgentReview 配置已更新/已恢复旧配置” | `src/__tests__/config/configWatcher.test.ts::防抖应合并多次事件，仅触发一次 onReload`；`src/__tests__/config/configWatcher.test.ts::dispose 应清理 timer 并释放两个 watcher`；`src/__tests__/config/configManager.test.ts::配置字段顺序变化不应该触发加载失败或回退` |
| UC-CONF-004 | P1 | 配置与环境变量 | 规则源解析 | 项目规则文件存在性变化 | 探测 project/builtin 规则来源并影响 ReviewEngine 分支 | 无 | 规则来源与项目态一致 | `rules.builtin_rules_enabled` | `config_snapshot` 与规则阶段行为一致 | `src/__tests__/config/configManager.test.ts::检测到项目规则文件且用户未显式配置时，builtin_rules_enabled 仍为 false、规则来源为 project` |

## 4. 异常与边界用例清单

| 场景ID | 关联用例ID | 边界条件 | 处理策略 | 验证测试 |
|---|---|---|---|---|
| EDGE-001 | UC-MAN-004 | 手动审查重复点击 | inProgress 防重入，第二次忽略 | `src/__tests__/commands/runReviewCommand.test.ts::并发双击刷新时应忽略第二次触发且不重复调用引擎` |
| EDGE-002 | UC-MAN-003 | reviewed 空结果但已有历史问题 | 保留历史，仅更新子状态 | `src/__tests__/commands/runReviewCommand.test.ts::reviewed+empty+有历史问题时应保留历史，不覆盖列表` |
| EDGE-003 | UC-AUTO-002 | 保存内容哈希与上次一致 | 跳过复审 `same_content` | `src/__tests__/core/autoReviewGate.test.ts::相同内容哈希应跳过 same_content` |
| EDGE-004 | UC-AUTO-004 | 仅格式/注释噪声变更 | 跳过复审 `noise_only_change` | `src/__tests__/core/autoReviewGate.test.ts::commentOnly 变更应跳过 noise_only_change` |
| EDGE-005 | UC-AUTO-005 | diagnostics 漏斗命中 | 跳过自动复审，优先修 diagnostics | `src/__tests__/core/autoReviewGate.test.ts::命中 error 级 diagnostics 漏斗时应跳过 diagnostic_funnel` |
| EDGE-006 | UC-AUTO-007 | 每分钟触发超过上限 | 进入冷却定时器，冷却后重试 | `src/__tests__/extension/autoReviewController.test.ts::save 前置门控：非 file 或 AI/save 开关关闭时不入队`（覆盖调度前置） |
| EDGE-007 | UC-AUTO-008 | 复审结果过期（revision 落后） | 丢弃过期结果，避免覆盖新状态 | `src/__tests__/extension/autoReviewController.test.ts::结果过期时应丢弃旧结果，不更新面板 patch` |
| EDGE-008 | UC-ENG-006 | scope hints 不可用或切片空结果 | 回退整文件复审 | `src/__tests__/core/reviewEngine.optimization.test.ts::切片复审返回空结果时，应回退整文件` |
| EDGE-009 | UC-ENG-007 | 忽略文件读取失败 | 仅跳过该文件忽略过滤，不中断整体 | `src/core/reviewEngine.ts::filterIgnoredIssues` |
| EDGE-010 | UC-AI-004 | 请求字符数超限 | 二分降载拆批 | `src/__tests__/core/aiReviewer.optimization.test.ts::请求超出 max_request_chars 时应自动二分降载` |
| EDGE-011 | UC-AI-007 | 模型返回 JSON 截断 | 发起续写并合并去重 | `src/__tests__/core/aiReviewer.optimization.test.ts::截断响应应触发续写并合并去重结果` |
| EDGE-012 | UC-AI-008 | diagnostics 过滤后结果为 0 | overdrop 回退保留原 AI 结果 | `src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts::diagnostics 过滤后若变为 0，应回退保留原 AI 结果` |
| EDGE-013 | UC-UI-003 | 问题行号越界或文件不存在 | 行号夹取安全范围；打开失败给警告 | `src/__tests__/phase3Optimization.test.ts::行列越界时安全降级` |
| EDGE-014 | UC-IGNORE-002 | 未选中问题执行放行 | 只提示，不写入注释 | `src/__tests__/commands/allowIssueIgnoreCommand.test.ts::未选中问题时应提示并返回` |
| EDGE-015 | UC-IGNORE-005 | 未选中问题执行忽略或 error 执行忽略 | 只提示，不写指纹/不移除 | `src/__tests__/commands/ignoreIssueCommand.test.ts::无 issue 时应提示请先选中或悬停`；`::error 级别时应提示不可忽略且不调用 removeIssueFromList` |
| EDGE-016 | UC-LOG-002 | 无运行日志文件 | 提示“未找到运行日志文件” | `src/__tests__/commands/explainRuntimeLogCommand.test.ts::应读取最新 jsonl 并生成 summary`（反向覆盖有日志路径） |
| EDGE-017 | UC-CONF-003 | YAML 语法错误或重载失败 | 回滚旧配置或默认配置并提示 | `src/__tests__/config/configLoader.test.ts::loadPluginYaml: YAML 解析失败时返回 null`；`src/__tests__/config/configManager.test.ts::应优雅处理格式错误的 YAML 文件` |

## 5. 配置项与命令映射表

### 5.1 命令映射

| 命令ID | 命令名称 | 主要行为 | 关联用例ID | 代码入口 |
|---|---|---|---|---|
| `agentreview.run` | 执行代码审查 | 审查 pending diff 并展示 | UC-MAN-001/002/003/004 | `src/commands/runReviewCommand.ts::registerRunReviewCommand` |
| `agentreview.runStaged` | 仅暂存变更审查 | 审查 staged diff | UC-MAN-005 | `src/commands/runStagedReviewCommand.ts::registerRunStagedReviewCommand` |
| `agentreview.review` | 兼容别名 | 转发到 `agentreview.run` | UC-MAN-006 | `src/commands/reviewCommand.ts` |
| `agentreview.refresh` | 刷新 | 转发到 `agentreview.run` | UC-MAN-006 | `src/commands/refreshCommand.ts` |
| `agentreview.showReport` | 显示报告 | reveal 侧边栏结果视图 | UC-MAN-006 | `src/commands/showReportCommand.ts` |
| `agentreview.reviewCurrentFileNow` | 立即复审当前文件 | 手动触发单文件自动复审队列 | UC-AUTO-010 | `src/extension.ts::registerAutoReviewOnSave/reviewCurrentFileNow` |
| `agentreview.allowIssueIgnore` | 放行 | 仅插入 `@ai-ignore` 注释（不写指纹） | UC-IGNORE-001/002/003 | `src/commands/allowIssueIgnoreCommand.ts` |
| `agentreview.ignoreIssue` | 忽略此条 | 仅写指纹（version 2 + meta）并从列表移除；仅 warning/info | UC-IGNORE-004/005 | `src/commands/ignoreIssueCommand.ts` |
| `agentreview.runtimeLog.explainLatest` | 解释最新运行日志 | 生成并打开 summary | UC-LOG-002 | `src/commands/explainRuntimeLogCommand.ts` |

### 5.2 关键配置映射

| 配置键 | 作用 | 关联用例ID | 代码入口 |
|---|---|---|---|
| `agentreview.ai.runOnSave` | 是否启用保存自动复审 | UC-AUTO-001 | `src/extension.ts::getRuntimeOptions` |
| `agentreview.ai.runOnSaveDebounceMs` | 保存防抖 | UC-AUTO-001 | `src/extension.ts::scheduleSaveReview` |
| `agentreview.ai.runOnSaveMaxRunsPerMinute` | 自动复审限频 | UC-AUTO-007 | `src/extension.ts::pruneExecutionWindow/scheduleCooldown` |
| `agentreview.ai.runOnSaveSkipSameContent` | 同内容跳过 | UC-AUTO-002 | `src/core/autoReviewGate.ts::evaluateAutoReviewGate` |
| `agentreview.ai.runOnSaveMinEffectiveChangedLines` | 小改动阈值 | UC-AUTO-006 | `src/core/autoReviewGate.ts` |
| `agentreview.ai.runOnSaveRiskPatterns` | 风险特征正则 | UC-AUTO-006 | `src/core/autoReviewGate.ts::hasRiskChange` |
| `agentreview.ai.runOnSaveFunnelLintSeverity` | 保存漏斗阈值 | UC-AUTO-005 | `src/core/autoReviewGate.ts` |
| `agentreview.ai.idleRecheckEnabled` / `idleRecheckMs` | 编辑停顿复审 | UC-AUTO-009 | `src/extension.ts::scheduleIdleReview` |
| `agentreview.ai.reviewCurrentFileNowBypassRateLimit` | 立即复审是否绕过限频 | UC-AUTO-010 | `src/extension.ts::reviewCurrentFileNow` |
| `agentreview.ai.funnelLint` / `funnelLintSeverity` | AI 前置 diagnostics 漏斗 | UC-ENG-002、UC-AI-008 | `src/core/reviewEngine.ts::filterFilesForAiReview` |
| `agentreview.ai.ignoreFormatOnlyDiff` / `ignoreCommentOnlyDiff` | 噪声 diff 过滤 | UC-AUTO-004、UC-ENG-005 | `src/core/reviewEngine.ts::filterFilesForAiReview` |
| `agentreview.ai.batchingMode` / `astSnippetBudget` / `astChunkStrategy` | AI 批次策略 | UC-AI-003 | `src/ai/aiReviewer.batching.ts` |
| `agentreview.ai.batchConcurrency` | 批次并发 | UC-AI-003 | `src/ai/aiReviewer.ts::processReviewUnitBatches` |
| `agentreview.ai.maxRequestChars` | 请求体长度上限 | UC-AI-004 | `src/ai/aiReviewer.ts::executeBatchWithFallback` |
| `agentreview.ai.retryCount` / `retryDelay` | API 重试策略 | UC-AI-006 | `src/ai/aiReviewer.api.ts::callReviewAPI` |
| `agentreview.ai.action` | AI 问题动作映射 | UC-AI-009 | `src/ai/aiReviewer.transform.ts`、`src/core/reviewEngine.ts::actionToSeverity` |
| `agentreview.ai.enableLocalRebase` / `largeChangeLineThreshold` | 本地行号重映射策略 | UC-UI-006 | `src/ui/reviewPanel.ts::syncAfterDocumentChange` |
| `agentreview.runtimeLog.*` | 运行链路日志开关、级别、目录、摘要 | UC-LOG-001/002/003 | `src/utils/runtimeTraceLogger.ts`、`src/utils/runtimeLogExplainer.ts` |

## 6. 实现与测试追踪矩阵（代码文件/测试文件）

| 功能域 | 用例ID范围 | 核心实现入口（类/方法） | 主要测试文件（现有） | 追踪结论 |
|---|---|---|---|---|
| 手动审查命令 | UC-MAN-001~006 | `runReviewCommand`、`runStagedReviewCommand`、`reviewCommand`、`refreshCommand`、`showReportCommand` | `src/__tests__/commands/runReviewCommand.test.ts`、`src/__tests__/commands/runStagedReviewCommand.test.ts`、`src/__tests__/commands/showReportCommand.test.ts`、`src/__tests__/core/reviewEngine.runtimeTrace.test.ts` | 命令主流程与保留历史、防重入可追踪 |
| 自动复审 | UC-AUTO-001~010 | `extension.ts::registerAutoReviewOnSave`、`autoReviewGate.ts::evaluateAutoReviewGate` | `src/__tests__/core/autoReviewGate.test.ts`、`src/__tests__/extension/autoReviewController.test.ts`、`src/__tests__/phase3Optimization.test.ts` | gate 分支与保存/空闲/手动调度、过期丢弃均可追踪 |
| 审查引擎 | UC-ENG-001~008 | `ReviewEngine.review*`、`filterFilesForAiReview`、`filterIgnoredIssues` | `src/__tests__/core/reviewEngine.test.ts`、`src/__tests__/core/reviewEngine.optimization.test.ts`、`src/__tests__/utils/fileScanner.diff.test.ts` | 阻断策略、diff 入口、scope fallback、结果仅含增量均有覆盖 |
| AI 流水线 | UC-AI-001~009 | `AIReviewer.review`、`aiReviewer.api.callReviewAPI`、`aiReviewer.batching`、`aiReviewer.responseParser`、`aiReviewer.transform`、`aiReviewer.contentLoader` | `src/__tests__/core/aiReviewer.optimization.test.ts`、`src/__tests__/core/aiReviewer.contextAndDiagnostics.test.ts`、`src/__tests__/ai/aiReviewer.responseParser.test.ts`、`src/__tests__/ai/aiReviewer.transform.test.ts`、`src/__tests__/ai/aiReviewer.contentLoader.test.ts` | 批次、降载、续写、JSON 修复、位置映射、内容加载兜底已覆盖 |
| UI 交互 | UC-UI-001~006 | `ReviewPanelProvider.getChildren`、`ReviewPanel.applyFileReviewPatch`、`syncAfterDocumentChange` | `src/__tests__/ui/reviewPanel.incremental.test.ts`、`src/__tests__/phase3Optimization.test.ts` | 分组展示、补丁替换、高亮定位、stale 同步可追踪 |
| 放行与忽略 | UC-IGNORE-001~005 | `allowIssueIgnoreCommand`（仅注释）、`ignoreIssueCommand`、`ignoreStore`（version 2 + meta）、`reviewPanel.removeIssue/removeIssueFromList`、`syncAfterIssueIgnore` | `src/__tests__/commands/allowIssueIgnoreCommand.test.ts`、`src/__tests__/phase3Optimization.test.ts`、`src/__tests__/config/ignoreStore.test.ts`、`src/__tests__/commands/ignoreIssueCommand.test.ts` | 放行多语言注释/失败兜底与忽略指纹移除链路均可追踪 |
| 运行日志 | UC-LOG-001~003 | `RuntimeTraceLogger`、`runtimeLogExplainer`、`explainRuntimeLogCommand`、`reviewEngine.runSummary` | `src/__tests__/utils/runtimeTraceLogger.test.ts`、`src/__tests__/utils/runtimeLogExplainer.test.ts`、`src/__tests__/commands/explainRuntimeLogCommand.test.ts`、`src/__tests__/core/reviewEngine.runSummary.test.ts` | 落盘、摘要、latest 解释与 runSummary 聚合链路完整 |
| 配置与环境变量 | UC-CONF-001~004 | `ConfigManager.loadConfig/reloadConfig/loadEnvFile`、`configLoader`、`configWatcher`、`envResolver`、`configMerger` | `src/__tests__/config/configManager.test.ts`、`src/__tests__/config/configMerger.test.ts`、`src/__tests__/config/configLoader.test.ts`、`src/__tests__/config/configWatcher.test.ts` | 优先级、回滚、YAML 读取、监听防抖与释放均可追踪 |

## 7. 验收标准

### 7.1 文档验收
- 覆盖 8 大功能域：`UC-MAN`、`UC-AUTO`、`UC-ENG`、`UC-AI`、`UC-UI`、`UC-IGNORE`、`UC-LOG`、`UC-CONF`。
- 每个功能域均不少于 3 条用例。
- 每条用例均包含主流程与异常流，并有至少 1 条现有测试映射。

### 7.2 追踪一致性验收
- 命令类用例与 `src/commands` 命令注册一一对应。
- 自动复审类用例与 `src/extension.ts` 自动复审控制逻辑对应。
- AI 类用例与 `src/ai` 批处理/重试/解析链路对应。

### 7.3 可执行性验收
- 任意实现者仅凭本文档可直接定位代码入口与测试入口。
- 用例可直接转化为新增或补充测试任务，无需额外产品决策。

### 7.4 覆盖统计
- 本表统计的是**设计级产品用例条数**（每条对应一个 UC-xxx 用例ID），与仓库中 Vitest 的 **测试用例个数**（`it(...)` 数量，当前约 229 个）不同：多条自动化测试可共同验证同一条产品用例，一条产品用例也可能拆成多段测试。
- `UC-MAN`：6
- `UC-AUTO`：10
- `UC-ENG`：8
- `UC-AI`：9
- `UC-UI`：6
- `UC-IGNORE`：5
- `UC-LOG`：3
- `UC-CONF`：4
- 合计：51（产品用例条数）

### 7.5 默认假设
- 仅描述当前实现，不纳入未来规划功能。
- 文档语言统一中文，文件编码 UTF-8。
- 优先级默认按 `P0/P1/P2` 规则执行。
- 功能汇总应以本文用例ID反推，不另起口径。
