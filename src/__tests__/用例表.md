# 测试用例归纳（人审用）

本文档按 `__tests__` 下目录与文件归纳所有测试用例，供人工评审时对照。**评审** 列可填写通过/待改/备注。

---

## config

### configManager.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应在没有配置文件时使用默认配置 | |
| 2 | 默认配置应包含所有必要字段 | |
| 3 | 检测到项目规则文件且用户未显式配置时，应默认开启 builtin_rules_enabled | |
| 4 | （无标题，见代码：YAML builtin_rules_enabled: false） | |
| 5 | 应能正确读取和解析 YAML 配置文件 | |
| 6 | （无标题，见代码：YAML git_hooks 等） | |
| 7 | 部分配置时命名规范可单独禁用 | |
| 8 | （无标题，见代码：部分配置时其他规则默认） | |
| 9 | 仅 Settings 时不应让默认覆盖 YAML 的 human_readable.auto_generate_on_run_end | |
| 10 | （无标题，见代码：未设置时 false） | |
| 11 | 仅 Settings 时不应让默认覆盖 YAML 的 ai_review.run_on_save | |
| 12 | 应优雅处理格式错误的 YAML 文件 | |
| 13 | 应处理不存在的配置文件 | |
| 14 | （无标题，见代码：空 YAML 默认配置） | |
| 15 | 配置字段顺序变化不应该触发加载失败或回退 | |
| 16 | （无标题，见代码） | |
| 17 | stableStringify 应处理嵌套对象 | |

### configMerger.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应保持 auto_generate_on_run_end 默认值为 false | |
| 2 | 当 defaultConfig 未提供 runtime_log 时，回退默认值也应为 false | |

---

## commands

### runReviewCommand.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | reviewed+empty+有历史问题时应保留历史，不覆盖列表 | |
| 2 | no_pending_changes 时应展示「没有待提交变更需要审查」 | |
| 3 | reviewed+non-empty 时应正常覆盖展示 | |

### explainRuntimeLogCommand.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应读取最新 jsonl 并生成 summary | |

---

## core

### aiReviewer.contextAndDiagnostics.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | AST 模式应在发送内容中区分当前审查代码与外部引用上下文 | |
| 2 | 应过滤与 diagnostics 同行的 AI 问题 | |
| 3 | diagnostics 过滤后若变为 0，应回退保留原 AI 结果 | |
| 4 | 构建请求时应带上已知问题白名单提示词 | |
| 5 | AST 模式应补充文件头依赖上下文，降低外部变量未定义误报 | |

### aiReviewer.optimization.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | batching_mode=file_count 时保持 5 文件一批 | |
| 2 | AST 60 片段按预算 25 分批时应拆为 3 批，且同文件多单元不丢失 | |
| 3 | 并发=2 时同一时刻最多执行 2 个批次 | |
| 4 | 请求超出 max_request_chars 时应自动二分降载 | |
| 5 | 400/context too long 时应触发批次二分降载重试 | |
| 6 | 截断响应应触发续写并合并去重结果 | |

### reviewEngine.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 严格模式下所有错误都应该阻止提交 | |
| 2 | 严格模式下即使只有 warning 也应该阻止提交 | |
| 3 | 非严格模式下只有 block_commit 的错误才阻止提交 | |
| 4 | 非严格模式下 block_commit 的错误应该阻止提交 | |
| 5 | 非严格模式下 warning 级别的错误不应该阻止提交 | |
| 6 | 应该使用映射表而不是硬编码来检查规则 action | |
| 7 | 应该正确处理 AI 审查规则的 action | |
| 8 | 应该正确处理未映射的规则（返回 false，不阻止提交） | |

### reviewEngine.optimization.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 规则引擎发现 blocking 错误时应跳过 AI 审查 | |
| 2 | 无 blocking 错时应执行 AI 审查 | |
| 3 | 规则引擎与 AI 审查重复应去重 | |
| 4 | 规则阶段应先于 AI 阶段执行 | |
| 5 | AI 审查调用应携带 diagnosticsByFile，用于去重白名单 | |
| 6 | 应基于 diff 行号正确标 incremental | |
| 7 | 保存触发路径中，formatOnly 文件应被 AI 过滤 | |
| 8 | 手动 run 应使用 pending diff 作为默认审查范围 | |
| 9 | reviewPendingChangesWithContext 在无 pending 变更时应返回 no_pending_changes | |
| 10 | reviewPendingChangesWithContext 在有 pending 变更时应返回 reviewed | |
| 11 | 保存复审应优先使用 pending diff，并返回 diff 覆盖范围上下文 | |
| 12 | 保存复审在 pending diff 不可用时应回退整文件并返回 full 上下文 | |
| 13 | reviewSavedFileWithPendingDiff 应保持兼容并返回 context.result | |
| 14 | 保存复审 scope hints 时，应构造切片 diff 与 AST override | |
| 15 | 保存复审无有效 scope hints 时，应回退整文件 | |
| 16 | 切片复审返回空结果时，应回退整文件 | |

### reviewEngine.runtimeTrace.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | staged 审查应输出关键链路事件（含 AI/LLM） | |
| 2 | 开启 AST 后应输出 AST 汇总事件 | |

### ruleEngine.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应该检测文件名中的空格并返回 error 级别的问题 | |
| 2 | 应该正确识别文件名中的空格位置 | |
| 3 | 应该检测文件名中的空格并返回 warning 级别的问题 | |
| 4 | warning 级别不应该阻止提交 | |
| 5 | 应该检测代码中的 TODO 注释 | |
| 6 | 应该正确记录 TODO 注释的行号和列号 | |
| 7 | 应该检测所有类型的 TODO 标记（不区分大小写） | |
| 8 | 禁用规则后不应该进行检查 | |
| 9 | 禁用全局规则后不应该进行任何检查 | |
| 10 | 应该能够同时检查多个文件 | |
| 11 | 应该跳过超过大小限制的文件 | |
| 12 | 应该跳过二进制文件 | |
| 13 | 应该跳过不存在的文件 | |
| 14 | 大文件和二进制文件跳过不应该影响其他文件 | |

---

## hooks

### gitHookManager.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | Windows 脚本应该使用完整 Node 路径 | |
| 2 | Unix 脚本应该使用完整 Node 路径 | |
| 3 | Windows 脚本应该使用 path.normalize 处理路径 | |
| 4 | Unix 脚本应该正确处理路径 | |
| 5 | 脚本应该包含错误处理逻辑 | |
| 6 | Unix 脚本应该包含错误处理逻辑 | |

---

## ui

### reviewPanel.incremental.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 根节点应出现规则检测错误与 AI 检测错误两个分组 | |
| 2 | 分组节点应按来源展示文件与问题 | |
| 3 | 仅展示增量问题，存量问题不应出现在分组里 | |
| 4 | 无问题时应优先展示场景化 emptyStateHint | |

---

## utils

### astScope.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | returns snippets for script block changes | |
| 2 | returns null when no hunks | |
| 3 | vue: respects maxNodeLines by dropping oversized snippet | |
| 4 | returns smallest containing node for changed line | |
| 5 | returns null for .vue when content is not SFC at all | |

### fileScanner.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应该排除匹配 *.log 模式的文件 | |
| 2 | 应该排除匹配 test-*.ts 模式的文件 | |
| 3 | 应该排除匹配目录模式的文件 | |
| 4 | 应该排除匹配多个模式的文件 | |
| 5 | 应该处理 Windows 路径 | |
| 6 | 应该支持花括号模式 {a,b} | |
| 7 | 应该支持字符类模式 [0-9] | |
| 8 | 应该支持多个复杂模式 | |
| 9 | 应该支持目录中的复杂 glob 模式 | |
| 10 | 应该支持 ** 通配符 | |
| 11 | 应该支持 ? 通配符 | |
| 12 | 没有排除规则时不应该排除任何文件 | |
| 13 | 应该处理空字符串模式 | |
| 14 | 应该处理包含特殊字符的文件名 | |

### fileScanner.diff.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 语义 diff 为空时应判定为 formatOnly=true | |
| 2 | 语义 diff 仍有内容时应判定为 formatOnly=false | |
| 3 | working diff 为空但文件为 untracked 时，应补充该文件的 diff hunk | |
| 4 | pending diff 应统一覆盖 tracked 与 untracked 文件 | |
| 5 | 无 HEAD 时应回退空树基准继续获取 pending diff | |

### runtimeLogExplainer.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 应解析 JSONL 并统计非法行 | |
| 2 | 应输出阶段摘要和关键事件 | |
| 3 | 瓶颈阶段耗时应优先使用阶段汇总事件，避免批次事件重复累计 | |
| 4 | 应生成 summary 文件 | |
| 5 | 应找到最新 jsonl 文件 | |

### runtimeLogPath.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | baseDirMode=workspace_docs_logs 且有工作区时，返回 workspace/docs/logs | |
| 2 | baseDirMode=workspace_docs_logs 且无工作区时，回退 globalStorage | |
| 3 | baseDirMode=global_storage 时使用 globalStorage，并在缺失时回退 extensionPath | |

### runtimeTraceLogger.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 每次运行会在 runtime-logs 下生成 JSONL 文件，且每行可解析 | |
| 2 | 连续两次运行应生成不同文件，互不覆盖 | |
| 3 | level=warn 时不落盘 info 事件 | |
| 4 | 启动时按 retention_days 清理过期文件 | |
| 5 | 运行链路日志会剔除结果统计字段 | |

---

## 根目录

### phase3Optimization.test.ts

| 序号 | 用例描述 | 评审 |
|-----|---------|------|
| 1 | 问题节点应配置打开文件与定位范围 | |
| 2 | 选中问题节点后应打开文件并定位到指定行列 | |
| 3 | 插入 @ai-ignore 后应本地同步行号并打上已放行标记 | |
| 4 | TreeView 问题节点应展示「已放行」前缀 | |
| 5 | 应提供 stale scope hints，并优先合并 AST 范围 | |
| 6 | stale_only 补丁应仅替换目标文件 stale 问题，并保留其他问题 | |
| 7 | stale_only + diff 覆盖范围应仅替换范围内 stale，范围外 stale 保留 | |
| 8 | preserveStaleOnEmpty=true 且无新问题时，应保留目标文件 stale 问题 | |
| 9 | 连续选择两个问题节点，高亮应更新并清理旧高亮 | |
| 10 | 选中文件节点或状态节点时不触发高亮 | |
| 11 | 文件不存在或路径无效时应提示并跳过 | |
| 12 | 行列越界时安全降级 | |
| 13 | 保存事件应走单文件 scope 复审入口 | |
| 14 | 新命令在激活时注册 | |
| 15 | TreeView 菜单仅对问题节点生效 | |

---

*文档由测试代码归纳生成，便于人审时逐条勾选。*
