# AgentReview 现状问题评估详情

本文档对照《VS Code AI Code Review 插件产品设计风险评估与解决方案报告》中的五项核心风险，对当前 AgentReview 项目实现进行逐项核查，给出**是否存在该问题**、**现状说明**与**差距摘要**，便于后续迭代优先级决策。

---

## 一、风险 1：“本次放行”机制的脆弱性（标记失效与 Git 污染）

### 报告中的问题描述

- 使用“文件 + 行号”注入 pre-commit 标记会导致行号变动后标记错位、失效或误判。
- 自动修改文件注入标记会产生 Git 脏区，打断心流。

### 报告中的解决方案概要

- 废弃行号绑定。
- 首选：代码内联注释（如 `// @ai-ignore: reason`），与代码物理绑定、可追溯。
- 备选：内容哈希标记，行号偏移仍可匹配。

### 当前项目现状

| 维度 | 现状 | 说明 |
|------|------|------|
| 是否使用行号绑定 | **否** | 未在 pre-commit 或任何地方用“文件+行号”作为放行标识。 |
| 是否修改业务代码 / 产生 Git 脏区 | **否** | 放行标记为 **`.git/agentreview/allow-commit`** 单文件，仅写入 `.git` 目录，不修改工作区文件。 |
| 放行粒度 | **整次提交** | “本次放行” = 下一次 commit 整次跳过审查，用完即删标记；**无**“单条问题放行”。 |

**实现位置摘要：**

- `allowCommitOnceCommand.ts`：在 Git 根下创建 `.git/agentreview/allow-commit`（可含 `allowed-at=...` 时间戳）。
- `hookRunner.ts`：若存在该文件则删除并 `exit(0)`，实现“放行一次”。

### 结论与差距

- **报告所担心的“行号绑定 + Git 脏区”在当前实现中不存在**：已采用“废弃行号 + 不碰工作区”的折中方案。
- **差距**：未实现报告推荐的**细粒度放行**（代码内联注释或内容哈希），无法对“单条问题”做放行，仅支持“整次提交放行”。

---

## 二、风险 2：AST 切片导致的上下文致盲（AI 幻觉与类型丢失）

### 报告中的问题描述

- AST 切片（Babel/Vue SFC）会使被切片函数丢失外部依赖（utils、TS Interface 等），导致 AI 产生“未定义变量”等幻觉误报。

### 报告中的解决方案概要

- 借力 LSP：用 `executeDefinitionProvider` 等补全外部引用上下文。
- 浅层追溯一层定义，避免 Token 爆炸。
- Prompt 中明确区分【当前审查代码】与【外部引用上下文（仅供参考）】。

### 当前项目现状

| 维度 | 现状 | 说明 |
|------|------|------|
| LSP / 语言服务 | **未使用** | 全代码库无 `executeDefinitionProvider`、Language Server 相关调用。 |
| AST 切片逻辑 | **仅按 diff 行号切片段** | `astScope.ts` 根据 `FileDiff` 的变更行收集最小 AST 节点并截取 `source`，**不**解析 import、不追溯定义。 |
| Prompt 中是否区分“当前审查”与“参考上下文” | **否** | `aiReviewer.ts` 中系统提示与请求体未区分“当前审查代码”与“外部引用（仅供参考）”槽位。 |

**实现位置摘要：**

- `utils/astScope.ts`：`getAffectedScopeWithDiagnostics` 仅做本文件内 AST 切片（Babel/Vue），无跨文件、无 LSP。
- `ai/aiReviewer.ts`：将切片或 diff 内容送入 AI，无“参考上下文”结构化槽位。

### 结论与差距

- **存在报告所述问题**：在仅送 AST 切片、无外部类型/定义信息时，AI 易对“未在当前片段内定义”的标识符报错，产生误报。
- **差距**：未实现 LSP 补全、未做浅层追溯、未在 Prompt 中做“当前审查 vs 参考上下文”的隔离。

---

## 三、风险 3：Pre-commit 拦截的性能瓶颈与团队抵触

### 报告中的问题描述

- 将耗时 AI Review 绑在 pre-commit 会导致 commit 极慢（网络、限流），易引发 `--no-verify` 绕过。

### 报告中的解决方案概要

- 降级为异步无感模式：侧边栏 + 编辑器 Diagnostic，在“保存”或“用户主动触发”时非阻塞检查。
- 漏斗式检测：不带明显语法/Lint 错误的代码才发 AI。
- 重度检查后置：pre-commit 仅极速本地 Lint，全量/深度 AI Review 放 CI/CD 或 MR。

### 当前项目现状

| 维度 | 现状 | 说明 |
|------|------|------|
| Pre-commit 是否跑 AI | **否** | `hookRunner.ts` 为独立 Node 脚本，**仅跑内置规则**（no_space_in_filename、no_todo），不调 VSCode、不调 AI。 |
| Pre-commit 耗时 | **低** | 仅本地文件读取 + 规则检查，无网络请求。 |
| AI 审查触发方式 | **仅“用户主动触发”** | 通过命令“执行代码审查”等触发 `reviewEngine.reviewStagedFiles()`，**未**在“保存文件”时自动跑、**未**与编辑器 Diagnostic 联动。 |
| 是否先拦语法/Lint 再发 AI | **否** | 未使用 VSCode Diagnostics 做漏斗，规则引擎与 AI 并行/串行由配置决定，无“先 Lint 再 AI”的强制漏斗。 |

**实现位置摘要：**

- `hooks/hookRunner.ts`：只做规则检查，无 AI、无网络。
- `extension.ts` / `runReviewCommand.ts`：AI 仅在扩展内、用户执行审查命令时调用。

### 结论与差距

- **报告所担心的“pre-commit 跑 AI 导致卡顿”在当前实现中不存在**：pre-commit 仅极速本地规则，符合“重度检查后置”。
- **差距**：  
  - 未实现“保存时”或“无感”异步检查（报告 MVP 主推）。  
  - 未实现“漏斗式检测”（先拦语法/Lint 再发 AI）。

---

## 四、风险 4：工程规范的碎片化与规则冲突（“标准”难以统一）

### 报告中的问题描述

- 插件强行内置“公司级标准规则”会与项目既有 .eslintrc 等冲突，导致老文件满屏红线、开发者抗拒。

### 报告中的解决方案概要

- 按需退让：启动时探测项目是否有规范配置（如 .eslintrc、tsconfig.json）；有则完全沿用项目规则、不注入内置；无才启用“公司底线规则”。
- Diff-Aware 分栏：侧边栏必须分“你的增量（默认展开）”与“项目存量（默认折叠）”，增量才阻断流程。

### 当前项目现状

| 维度 | 现状 | 说明 |
|------|------|------|
| 是否自动探测项目规范 | **否** | 未在启动或配置加载时探测 .eslintrc、tsconfig.json 等；**builtin_rules_enabled** 完全由配置/默认值决定（默认 `false`）。 |
| 是否“有项目规则则退让” | **配置级退让** | 通过默认 `builtin_rules_enabled: false` 和说明“避免与项目自有规则冲突”，由用户或 YAML 决定是否开内置规则；**非**“探测到 .eslintrc 则自动关闭”。 |
| 侧边栏是否“增量 vs 存量”分栏 | **否** | `reviewPanel.ts` 仅按**文件**分组展示 errors/warnings/info，**未**按“本次变更触发的问题”与“存量问题”分栏，也**未**默认展开增量、折叠存量。 |

**实现位置摘要：**

- `configManager.ts` / `types/config.ts`：`builtin_rules_enabled` 默认 false，无探测逻辑。
- `ui/reviewPanel.ts`：`getChildren` 等按 `reviewResult` 的文件/问题列表建树，无 diff 维度的“增量/存量”拆分。

### 结论与差距

- **部分缓解**：通过默认关闭内置规则和文档说明，降低了与现有规范的冲突概率，但**非**报告所提的“探测后自动退让”。
- **存在差距**：  
  - 未实现“探测项目规范 → 自动退让”。  
  - 未实现“你的增量”与“项目存量”分栏展示及默认展开/折叠策略。

---

## 五、风险 5：Linter 警告与 AI 审查的职责重叠（重复劳作与 Token 浪费）

### 报告中的问题描述

- 规则引擎/Linter 已发现的 Warning 若再交给 AI，AI 可能重复指出，导致报告冗余、浪费 Token。

### 报告中的解决方案概要

- AST 节点注释化：在发给 AI 的切片上，按 Linter 报错行号插入如 `// [AI IGNORE]: <Lint Message>`。
- Prompt 上下文抑制：系统 Prompt 中【已知问题白名单】区块，让 AI 忽略已由静态工具捕获的问题。
- 后置清洗：AI 返回建议与本地 Linter Diagnostics 按行号比对，重合则过滤。

### 当前项目现状

| 维度 | 现状 | 说明 |
|------|------|------|
| 是否读取 VSCode Linter/TS Diagnostics | **否** | 未调用 `vscode.languages.getDiagnostics()` 或类似 API 获取当前文件的 Lint/TS 报错。 |
| 是否在发给 AI 的代码中插入 [AI IGNORE] | **否** | `aiReviewer` 未在 AST 切片或 diff 内容上按行号插入屏蔽注释。 |
| 系统 Prompt 是否有“已知问题白名单” | **否** | `DEFAULT_SYSTEM_PROMPT` 及请求构建中无“以下问题已由 Linter 发现，请忽略”类区块。 |
| 是否对 AI 结果做“与 Diagnostics 行号比对”的后置过滤 | **否** | 审查结果直接展示，未与 VSCode Diagnostics 做去重。 |

**实现位置摘要：**

- `ai/aiReviewer.ts`：仅使用配置中的 system_prompt 与代码内容，无 Linter 输入、无白名单、无后置清洗。
- `core/reviewEngine.ts`：合并规则引擎与 AI 结果时仅做 **IssueDeduplicator**（同文件同行同列+消息归一化去重），**未**与编辑器 Diagnostic 做比对。

### 结论与差距

- **存在报告所述问题**：规则引擎与 AI 可能对同一类问题（如格式、简单逻辑）重复报，导致冗余与 Token 浪费。
- **差距**：未实现 AST 节点注释化、Prompt 已知问题白名单、以及与 Linter/Diagnostics 的后置清洗。

---

## 六、汇总表

| 风险项 | 报告所担心的问题是否存在 | 现状简述 | 建议优先级（参考） |
|--------|--------------------------|----------|--------------------|
| 1. 本次放行机制 | **否**（已避免行号+脏区） | 使用 .git 下标记文件，整次提交放行；无单条放行 | 中：若要单条放行再做内联注释/哈希 |
| 2. AST 上下文致盲 | **是** | 无 LSP、无外部上下文、无 Prompt 隔离 | 高：直接影响 AI 误报率 |
| 3. Pre-commit 性能 | **否** | pre-commit 仅规则、不跑 AI；AI 仅命令触发 | 中：可做“保存时/无感”与漏斗式检测 |
| 4. 规范碎片化与分栏 | **部分** | 配置级退让、默认关内置规则；无探测、无增量/存量分栏 | 高：分栏体验核心；探测可后续 |
| 5. Linter 与 AI 重叠 | **是** | 无 Diagnostic 接入、无白名单、无后置清洗 | 高：影响体验与成本 |

---

## 七、说明与引用

- 本评估基于当前 AgentReview 代码库（含 `extension.ts`、`reviewEngine.ts`、`hookRunner.ts`、`aiReviewer.ts`、`reviewPanel.ts`、`configManager.ts`、`astScope.ts` 等）的静态阅读与 grep 结果。
- 对照依据为《VS Code AI Code Review 插件产品设计风险评估与解决方案报告》中的五项核心问题与解决方案概要。
- 若后续实现有变更，建议同步更新本文档或注明评估基准版本/日期。
